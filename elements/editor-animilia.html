<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../behaviors/toast-behavior.html">
<link rel="import" href="../behaviors/input-behavior.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">





<!-- componente <complaint-animilia> -->
<link rel="import" href="complaint-animilia.html">
<!-- componente <current-location.html> -->


<link rel="import" href="complaint-list-animilia.html">


<!-- imports que corresponden al componente <complaint-animilia> -->
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">

<!--
`editor-animilia`
editor con el que vamos poder guardar las denuncias, editarlas, etc

@demo demo/index.html 
-->

<dom-module id="editor-animilia">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <firebase-auth 
            app-name="form-polymerfire"
            id="auth" 
            user="{{user}}">
    </firebase-auth>

    <paper-fab icon="add" id="createComplaint"></paper-fab>

    
    
      <complaint-animilia
          name="create"     
          complaint="{{complaint}}"     
          inputs="{{inputs}}">
        </complaint-animilia>


   

    <paper-fab icon="done" id="saveButton"></paper-fab>
    <paper-button raised on-tap="update">update</paper-button>
        
         <firebase-query
            id="query"
            app-name="form-polymerfire"
            path="/denuncias/[[user.uid]]"
            data="{{data}}">

        </firebase-query>

    <template name="list" is="dom-repeat" items="[[data]]" as="complaint">  
  
      <paper-card 
            heading="[[complaint.identificador]]" 
            image="https://t1.ea.ltmcdn.com/es/images/9/7/5/img_nombres_para_perros_originales_y_bonitos_5579_paso_1_600.jpg" 
            alt="[[complaint.identificador]]">
          
            <div class="card-content">
            [[complaint.descripcion]]
          </div>
           <div class="card-actions">
              <paper-button complaint="[[complaint]]" on-tap="edition">Editar</paper-button>
              <paper-button complaint="[[complaint]]" on-tap="remove">Deletar</paper-button>
              <paper-button>Enviar</paper-button>
          </div>
     </paper-card>

    </template>   



  </template>

  <script>
    Polymer({

      is: 'editor-animilia',

      properties: {
         user:Object,
         logueado: Boolean,
         data:Array,
         complaint:Object,
         section:{
            type:String,
            value:'list'
         },
        
       
      },

      behaviors: [Polymer.inputBehavior, Polymer.animiliaBehavior],


      listeners:{
         'saveButton.tap': 'save',
         'getplace':'getPlace'
     },

      // método que hace de enlace con el componente <paper-input-place>. Cuando <paper-input-place> selecciona la dirección, se lanza el evento 'getplace' en ese componente, que a su vez lanza el evento 'getPlace' en este componente recibiendo como parámetro la dirección y se setea a la propiedad complaint.address
      getPlace:function(e,place){
      this.set('complaint.address',place.formatted_address)
    },

      // método para guardar los datos de la denuncia en Firebase
      save:function(){
   
        if(this.complaint.identificador && this.complaint.address && this.complaint.descripcion){
          // sube los datos de la denuncia a Firebase
          this.$.query.ref.push(this.complaint);
          this.fire('positive-toast', 'denúncia guardada');
          // después de introducir los valores en los input se limpia el texto
          this.complaint= {         
                identificador:'',
                descripcion:'',
                fecha:new Date().toLocaleString(),
                address:''
            };
          
        }else{
          // al clickar en el botón 'guardar' se lanza el mètodo validator, incluido en el behavior, que valida los inputs
          for(var i = 0; i < this.inputs.length; i++ ){
              this.validator(this.inputs[i])
           };

        };                          

      },

    createComplaint:function(){
        this.section = 'create'
    },


    remove:function(e) {   
      this.delete(e.currentTarget.complaint);   
     },

    edition:function(e){
     var key = e.currentTarget.complaint.$key;
     var fireComplaint = e.currentTarget.complaint;
    console.log(fireComplaint);
    console.log(key);
   //  console.log(this.complaint)
   
      this.set('complaint.identificador',fireComplaint.identificador);
     

    },

       update:function(key){
     
        this.$.query.ref.child(key).update({
           identificador: this.complaint.identificador,
           descripcion: this.complaint.descripcion,
           fecha: new Date().toLocaleString(),
           address: this.complaint.address
        })
      },
    

    });
  </script>
</dom-module>
